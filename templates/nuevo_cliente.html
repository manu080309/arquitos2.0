{% extends "base.html" %}
{% block title %}Nuevo Cliente{% endblock %}
{% block content %}
<h2>🧾 Nuevo Cliente</h2>
<p class="text-muted mb-4">🕒 Hora actual en Chile: {{ hora_actual() }}</p>


<form id="formCliente" action="{{ url_for('app_rutas.nuevo_cliente') }}" method="post" class="row g-3">

  <!-- BLOQUE 1: Nombre y Dirección -->
  <div class="card mb-3 p-3 w-100" id="bloqueNombreDireccion">
    <div class="row g-3">
      <div class="col-md-6">
        <label for="nombre" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="nombre" name="nombre"
               placeholder="(solo si el código es nuevo)">
      </div>
      <div class="col-md-6">
        <label for="direccion" class="form-label">Dirección</label>
        <input type="text" class="form-control" id="direccion" name="direccion"
               placeholder="(opcional si el cliente ya existe)">
      </div>
    </div>
    <div class="mt-3">
      <button type="button" class="btn btn-primary" id="generarCodigoBtn">Generar Código</button>
    </div>
  </div>

  <!-- BLOQUE 2: Datos del préstamo -->
  <div class="col-md-3">
    <label for="codigo" class="form-label">Código Cliente</label>
    <input type="text" class="form-control" id="codigo" name="codigo" 
           required pattern="\d{6}" title="Debe tener 6 dígitos">
  </div>

  <div class="col-md-2">
    <label for="orden" class="form-label">Orden</label>
    <input type="number" class="form-control" id="orden" name="orden" required min="1">
  </div>

  <div class="col-md-3">
    <label for="monto" class="form-label">Monto</label>
    <input type="number" step="0.01" class="form-control" id="monto" name="monto" required min="1">
  </div>

  <div class="col-md-2">
    <label for="plazo" class="form-label">Plazo (días)</label>
    <input type="number" class="form-control" id="plazo" name="plazo" required min="1">
  </div>

  <div class="col-md-2">
    <label for="interes" class="form-label">Interés (%)</label>
    <input type="number" step="0.01" class="form-control" id="interes" name="interes" required min="0">
  </div>

  <div class="col-md-3 mt-3">
    <label for="frecuencia" class="form-label">Frecuencia de Pago</label>
    <select id="frecuencia" name="frecuencia" class="form-control" required>
      <option value="diario">Diario</option>
      <option value="semanal">Semanal</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
  </div>

  <div class="col-md-3 mt-3">
    <label for="cuota" class="form-label">Cuotas calculadas</label>
    <input type="text" id="cuota" class="form-control" readonly>
  </div>

  <div class="col-12 mt-3">
    <button type="submit" class="btn btn-success">Guardar Cliente</button>
    <a href="{{ url_for('app_rutas.index') }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<!-- Script -->
<script>
  // 🔢 Generar código numérico aleatorio
  function generarCodigoNumerico() {
    let codigo = '';
    const caracteres = '0123456789';
    for (let i = 0; i < 6; i++) {
      codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    return codigo;
  }

  // 🧩 Botón "Generar Código"
  document.getElementById('generarCodigoBtn').addEventListener('click', function() {
    const nombre = document.getElementById('nombre').value.trim();
    const direccion = document.getElementById('direccion').value.trim();

    if (!nombre || !direccion) {
      alert("Ingresa Nombre y Dirección antes de generar código.");
      return;
    }

    document.getElementById('codigo').value = generarCodigoNumerico();
  });

  // 🔍 Verificar si el código ya existe y autocompletar
  document.getElementById('codigo').addEventListener('change', async function() {
    const codigo = this.value.trim();
    if (!codigo) return;

    const response = await fetch(`/api/cliente/${codigo}`);
    const data = await response.json();

    if (data.existe) {
      document.getElementById('nombre').value = data.nombre;
      document.getElementById('direccion').value = data.direccion;
      document.getElementById('bloqueNombreDireccion').style.display = 'none';

      // Mostrar alerta si está cancelado
      if (data.cancelado) {
        alert(`⚠️ El cliente "${data.nombre}" está cancelado. Se reactivará al guardar.`);
      }
    } else {
      alert("Código no existe. Puedes crear un nuevo cliente.");
      document.getElementById('nombre').value = '';
      document.getElementById('direccion').value = '';
      document.getElementById('bloqueNombreDireccion').style.display = 'block';
    }

    calcularCuota();
  });

  // 💰 Calcular cuotas según monto, plazo y frecuencia
  function calcularCuota() {
    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const plazo = parseInt(document.getElementById('plazo').value) || 0;
    const frecuencia = document.getElementById('frecuencia').value;
    let numeroCuotas = 0;

    switch (frecuencia) {
      case 'diario': numeroCuotas = plazo; break;
      case 'semanal': numeroCuotas = Math.floor(plazo / 7); break;
      case 'quincenal': numeroCuotas = Math.floor(plazo / 15); break;
      case 'mensual': numeroCuotas = Math.floor(plazo / 30); break;
    }

    const valorCuota = numeroCuotas > 0 ? monto / numeroCuotas : 0;
    document.getElementById('cuota').value = numeroCuotas > 0
      ? `${numeroCuotas} cuotas de ${valorCuota.toFixed(2)}`
      : 'Plazo insuficiente';
  }

  // Recalcular al cambiar valores
  ['monto', 'plazo', 'frecuencia'].forEach(id => {
    document.getElementById(id).addEventListener('input', calcularCuota);
    document.getElementById(id).addEventListener('change', calcularCuota);
  });

  window.addEventListener('load', calcularCuota);
</script>

{% endblock %}
