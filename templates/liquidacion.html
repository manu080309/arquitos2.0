{% extends "base.html" %}
{% block title %}📊 Liquidación del Día{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">

  <!-- 🧭 ENCABEZADO PRINCIPAL -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary mb-2">📊 Liquidación del Día</h2>
    <p class="text-muted">Resumen financiero de movimientos, caja y préstamos</p>

    <div class="d-flex justify-content-center gap-2 flex-wrap">
      <a href="{{ url_for('app_rutas.liquidaciones') }}" class="btn btn-outline-secondary btn-sm">📜 Ver Historial</a>
      <a id="btn-reparar-caja" href="{{ url_for('app_rutas.reparar_caja') }}" 
         class="btn btn-outline-danger btn-sm d-none">🧹 Reparar Caja</a>
    </div>
  </div>

  <!-- 💵 FORMULARIOS DE MOVIMIENTOS -->
  <div class="row g-3 justify-content-center mb-4">
    <!-- Entrada -->
    <div class="col-md-3">
      <div class="card border-success shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-success fw-bold mb-3">💰 Entrada de Efectivo</h6>
          <form action="{{ url_for('app_rutas.caja_movimiento', tipo='entrada_manual') }}" method="POST">
            <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control form-control-sm mb-2" required>
            <input type="text" name="descripcion" placeholder="Descripción (opcional)" class="form-control form-control-sm mb-3">
            <button type="submit" class="btn btn-success btn-sm w-100">Registrar Entrada</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Salida -->
    <div class="col-md-3">
      <div class="card border-warning shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-warning fw-bold mb-3">💸 Salida de Efectivo</h6>
          <form action="{{ url_for('app_rutas.caja_movimiento', tipo='salida') }}" method="POST">
            <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control form-control-sm mb-2" required>
            <input type="text" name="descripcion" placeholder="Descripción (opcional)" class="form-control form-control-sm mb-3">
            <button type="submit" class="btn btn-warning btn-sm w-100 text-dark">Registrar Salida</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Gasto -->
    <div class="col-md-3">
      <div class="card border-danger shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-danger fw-bold mb-3">🧾 Registrar Gasto</h6>
          <form action="{{ url_for('app_rutas.caja_movimiento', tipo='gasto') }}" method="POST">
            <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control form-control-sm mb-2" required>
            <input type="text" name="descripcion" placeholder="Descripción (opcional)" class="form-control form-control-sm mb-3">
            <button type="submit" class="btn btn-danger btn-sm w-100">Registrar Gasto</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 📅 RESUMEN DIARIO -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body text-center">
      <h5 class="fw-bold mb-3 text-primary">📅 Resumen — {{ hoy.strftime("%d/%m/%Y") }}</h5>
      <div class="row row-cols-2 row-cols-md-4 g-3">
        <div><strong>📦 Caja Anterior:</strong><br>${{ "%.2f"|format(liq.caja_manual or 0) }}</div>
        <div class="text-success"><strong>💰 Abonos:</strong><br>${{ "%.2f"|format(liq.entradas or 0) }}</div>
        <div class="text-info"><strong>💵 Entradas:</strong><br>${{ "%.2f"|format(liq.entradas_caja or 0) }}</div>
        <div class="text-primary"><strong>🏦 Préstamos:</strong><br>${{ "%.2f"|format(liq.prestamos_hoy or 0) }}</div>
        <div class="text-warning"><strong>💸 Salidas:</strong><br>${{ "%.2f"|format(liq.salidas or 0) }}</div>
        <div class="text-danger"><strong>🧾 Gastos:</strong><br>${{ "%.2f"|format(liq.gastos or 0) }}</div>
        <div class="{% if (liq.caja or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
          <strong>💼 Caja Final:</strong><br>${{ "%.2f"|format(liq.caja or 0) }}
        </div>
      </div>
    </div>
  </div>

  <!-- 📋 TABLA DE LIQUIDACIONES -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-0">
      <table class="table table-hover table-bordered align-middle text-center mb-0">
        <thead class="table-dark">
          <tr>
            <th>📅 Fecha</th>
            <th>📦 Caja Ant.</th>
            <th>💰 Abonos</th>
            <th>💵 Entradas</th>
            <th>🏦 Préstamos</th>
            <th>💸 Salidas</th>
            <th>🧾 Gastos</th>
            <th>💼 Caja Final</th>
          </tr>
        </thead>
        <tbody>
          {% for l in liquidaciones %}
          <tr>
            <td>{{ l.fecha.strftime("%d/%m/%Y") }}</td>
            <td>${{ "%.2f"|format(l.caja_manual or 0) }}</td>
            <td><a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='abono', fecha=l.fecha.strftime('%Y-%m-%d')) }}" class="text-success fw-bold">$ {{ "%.2f"|format(l.entradas or 0) }}</a></td>
            <td><a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='entrada_manual', fecha=l.fecha.strftime('%Y-%m-%d')) }}" class="text-info fw-bold">$ {{ "%.2f"|format(l.entradas_caja or 0) }}</a></td>
            <td><a href="{{ url_for('app_rutas.prestamos_por_dia', fecha=l.fecha.strftime('%Y-%m-%d')) }}" class="text-primary fw-bold">$ {{ "%.2f"|format(l.prestamos_hoy or 0) }}</a></td>
            <td><a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='salida', fecha=l.fecha.strftime('%Y-%m-%d')) }}" class="text-warning fw-bold">$ {{ "%.2f"|format(l.salidas or 0) }}</a></td>
            <td><a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='gasto', fecha=l.fecha.strftime('%Y-%m-%d')) }}" class="text-danger fw-bold">$ {{ "%.2f"|format(l.gastos or 0) }}</a></td>
            <td class="{% if (l.caja or 0) >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
              ${{ "%.2f"|format(l.caja or 0) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 📦 TOTALES FINALES -->
  <div class="card shadow-sm border-0 text-center bg-light py-3">
    <strong>📦 Caja total:</strong> ${{ "%.2f"|format(total_caja) }} |
    <strong>💳 Cartera total:</strong> ${{ "%.2f"|format(cartera_total) }} <br>
    <span class="text-muted">🕒 Hora actual en Chile: {{ hora_actual() }}</span>
  </div>
</div>

<!-- 🧠 SCRIPT PARA BOTÓN DE REPARAR -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('{{ url_for("app_rutas.revisar_caja_estado") }}');
    const data = await res.json();
    if (data.errores > 0) {
      const btn = document.getElementById('btn-reparar-caja');
      btn.classList.remove('d-none');
      btn.textContent = `🧹 Reparar Caja (${data.errores} error${data.errores > 1 ? 'es' : ''})`;
      btn.onclick = e => {
        if (!confirm('⚠️ ¿Seguro que deseas recalcular la caja del día?')) e.preventDefault();
      };
    }
  } catch (err) {
    console.error('Error verificando caja:', err);
  }
});
</script>

<!-- 🎨 ESTILOS -->
<style>
  .table td, .table th { vertical-align: middle; }
  .card { border-radius: 12px; }
  .btn { border-radius: 8px; }
  .shadow-sm { box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important; }
</style>
{% endblock %}
