{% extends "base.html" %}
{% block title %}Historial de Liquidaciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">üìú Historial de Liquidaciones</h2>
  <p class="text-center text-muted mb-3">üïí Hora actual en Chile: {{ hora_chile(hora_actual()) }}</p>

  <!-- FORMULARIO DE B√öSQUEDA -->
  <form method="get" class="row g-3 mb-4 justify-content-center">
    <div class="col-md-3">
      <label for="desde" class="form-label">Desde</label>
      <input type="date" id="desde" name="desde" value="{{ fecha_desde }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label for="hasta" class="form-label">Hasta</label>
      <input type="date" id="hasta" name="hasta" value="{{ fecha_hasta }}" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">üîç Buscar</button>
    </div>
  </form>

  {% if fecha_desde and fecha_hasta %}
  <p class="text-center text-muted">
    Mostrando desde <strong>{{ fecha_desde }}</strong> hasta <strong>{{ fecha_hasta }}</strong>
  </p>
  {% endif %}

  <!-- TABLA DE LIQUIDACIONES -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Fecha</th>
          <th>Caja Anterior</th>
          <th>Ingresos (Abonos)</th>
          <th>Entradas Caja</th>
          <th>Pr√©stamos</th>
          <th>Salidas</th>
          <th>Gastos</th>
          <th>Caja Final</th>
        </tr>
      </thead>
      <tbody>
        {% if liquidaciones %}
          {% for liq in liquidaciones %}
          <tr>
            <td>{{ liq.fecha.strftime("%d-%m-%Y") }}</td>
            <td>${{ "%.2f"|format(liq.caja_manual or 0) }}</td>

            <!-- üí∞ Clickable: Ingresos (abonos) -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='entrada', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-success fw-bold hover-underline">
                ${{ "%.2f"|format(liq.entradas or 0) }}
              </a>
            </td>

            <!-- üíµ Clickable: Entradas manuales -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='entrada_manual', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-info fw-bold hover-underline">
                ${{ "%.2f"|format(liq.entradas_caja or 0) }}
              </a>
            </td>

            <!-- üè¶ Clickable: Pr√©stamos -->
            <td>
              <a href="{{ url_for('app_rutas.prestamos_por_dia', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-primary fw-bold hover-underline">
                ${{ "%.2f"|format(liq.prestamos_hoy or 0) }}
              </a>
            </td>

            <!-- üí∏ Clickable: Salidas -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='salida', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-warning fw-bold hover-underline">
                ${{ "%.2f"|format(liq.salidas or 0) }}
              </a>
            </td>

            <!-- üßæ Clickable: Gastos -->
            <td>
              <a href="{{ url_for('app_rutas.movimientos_por_dia', tipo='gasto', fecha=liq.fecha.strftime('%Y-%m-%d')) }}"
                 class="text-decoration-none text-danger fw-bold hover-underline">
                ${{ "%.2f"|format(liq.gastos or 0) }}
              </a>
            </td>

            <!-- üíº Caja Final -->
            {% if (liq.caja or 0) >= 0 %}
              <td class="text-success"><strong>${{ "%.2f"|format(liq.caja or 0) }}</strong></td>
            {% else %}
              <td class="text-danger"><strong>${{ "%.2f"|format(liq.caja or 0) }}</strong></td>
            {% endif %}
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8">No hay liquidaciones en el rango seleccionado.</td></tr>
        {% endif %}
      </tbody>

      {% if liquidaciones %}
      <tfoot class="table-light">
        <tr>
          <th>Total</th>
          <th>-</th>
          <th class="text-success fw-bold">${{ "%.2f"|format(total_entradas) }}</th>
          <th class="text-info fw-bold">${{ "%.2f"|format(total_entradas_caja) }}</th>
          <th class="text-primary fw-bold">${{ "%.2f"|format(total_prestamos) }}</th>
          <th class="text-warning fw-bold">${{ "%.2f"|format(total_salidas) }}</th>
          <th class="text-danger fw-bold">${{ "%.2f"|format(total_gastos) }}</th>
          <th class="text-success fw-bold">${{ "%.2f"|format(total_caja) }}</th>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>

  <div class="mt-3 text-center">
    <!-- ‚úÖ Corregido el prefijo -->
    <a href="{{ url_for('app_rutas.liquidacion_view') }}" class="btn btn-secondary">‚¨ÖÔ∏è Volver a Liquidaci√≥n del D√≠a</a>
  </div>
</div>

<style>
  .table td, .table th { vertical-align: middle; }
  .text-success strong { color: #198754; }
  .text-danger strong { color: #dc3545; }
  .text-warning strong { color: #ffc107; }
  .text-primary strong { color: #0d6efd; }

  /* ‚ú® Hover clickables */
  .hover-underline:hover {
    text-decoration: underline;
    opacity: 0.9;
  }
</style>
{% endblock %}
